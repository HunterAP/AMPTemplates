[
    {
        "UpdateStageName": "Client Download",
        "UpdateSourcePlatform": "Linux",
        "UpdateSource": "SteamCMD",
        "UpdateSourceData": "704450",
        "UpdateSourceArgs": "704450",
        "UpdateSourceConditionSetting": "DisableClientDownload",
        "UpdateSourceConditionValue": "false",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Client Data Copy",
        "UpdateSourcePlatform": "Linux",
        "UpdateSource": "Executable",
        "UpdateSourceData": "/bin/bash",
        "UpdateSourceArgs": "-c \"\\cp -rf ./nwnee/704450/data/. ./nwnee/server/data >/dev/null 2>&1\"",
        "UpdateSourceConditionSetting": "DisableClientDownload",
        "UpdateSourceConditionValue": "false",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "User Modules Directories Creation",
        "UpdateSourcePlatform": "Linux",
        "UpdateSource": "CreateDirectory",
        "UpdateSourceArgs": "{{$FullBaseDir}}user/modules",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Server Download",
        "UpdateSourcePlatform": "Linux",
        "UpdateSource": "Executable",
        "UpdateSourceData": "/bin/bash",
        "UpdateSourceArgs": "-c \"cd nwnee/server && ReleaseVersion=\\\"{{ReleaseVersion}}\\\"; [[ -z \\\"$ReleaseVersion\\\" ]] && ReleaseVersion=$(wget -qO- https://nwn.beamdog.net/downloads/ | sed -n \\\"s/^.*nwnee-dedicated-\\([0-9.-]*\\)\\.zip.*/\\1/p\\\" | sort -V | tail -1); if [[ ! \\\"$ReleaseVersion\\\" =~ ^[0-9]+((-|\\.)[0-9]+)?((-|\\.)[0-9]+)?$ ]]; then echo \\\"Invalid server version format specified\\\" && exit 1; else [[ -f nwnee.zip ]] && rm -f nwnee.zip >/dev/null 2>&1; wget -qO nwnee.zip https://nwn.beamdog.net/downloads/nwnee-dedicated-$ReleaseVersion.zip || { echo \\\"Download failed from the Beamdog website. Aborting\\\"; exit 1; }; unzip -oq nwnee.zip -d . >/dev/null 2>&1 && rm -f nwnee.zip >/dev/null 2>&1 && chmod +x bin/linux-x86/nwserver-linux && echo \\\"Server v$ReleaseVersion downloaded\\\"; fi\"",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Demo Mod Download",
        "UpdateSourcePlatform": "Linux",
        "UpdateSource": "FetchURL",
        "UpdateSourceData": "https://raw.githubusercontent.com/urothis/nwserver/refs/heads/main/DockerDemo.mod",
        "UpdateSourceTarget": "{{$FullBaseDir}}user/modules",
        "UpdateSourceArgs": "Demo.mod",
        "OverwriteExistingFiles": true,
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Install Python",
        "UpdateSourcePlatform": "Linux",
        "UpdateSource": "Executable",
        "UpdateSourceData": "/bin/bash",
        "UpdateSourceArgs": "-c \"sudo apt update && sudo apt install -y python3\"",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Start Server",
        "UpdateSourcePlatform": "Linux",
        "UpdateSource": "StartApplication"
    },
    {
        "UpdateStageName": "Wait For Server Start",
        "UpdateSourcePlatform": "Linux",
        "UpdateSource": "WaitForStartupComplete"
    },
    {
        "UpdateStageName": "Stop Server",
        "UpdateSourcePlatform": "Linux",
        "UpdateSource": "ShutdownApplication"
    },
    {
        "UpdateStageName": "Client Download",
        "UpdateSourcePlatform": "Windows",
        "UpdateSource": "SteamCMD",
        "UpdateSourceData": "704450",
        "UpdateSourceArgs": "704450",
        "UpdateSourceConditionSetting": "DisableClientDownload",
        "UpdateSourceConditionValue": "false",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Client Data Copy",
        "UpdateSourcePlatform": "Windows",
        "UpdateSource": "Executable",
        "UpdateSourceData": "powershell.exe",
        "UpdateSourceArgs": "-Command \"Copy-Item -Path './nwnee/704450/data/*' -Destination './nwnee/server/data' -Recurse -Force\"",
        "UpdateSourceConditionSetting": "DisableClientDownload",
        "UpdateSourceConditionValue": "false",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "User Modules Directories Creation",
        "UpdateSourcePlatform": "Windows",
        "UpdateSource": "CreateDirectory",
        "UpdateSourceArgs": "{{$FullBaseDir}}user/modules",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Server Download",
        "UpdateSourcePlatform": "Windows",
        "UpdateSource": "Executable",
        "UpdateSourceData": "powershell.exe",
        "UpdateSourceArgs": "-Command \"$ReleaseVersion = '{{ReleaseVersion}}'; if (-not $ReleaseVersion) { $ReleaseVersion = (Invoke-WebRequest -Uri 'https://nwn.beamdog.net/downloads/' | Select-String -Pattern 'nwnee-dedicated-([0-9.-]+)\\\\.zip' | % { $_.Matches.Groups[1].Value } | Sort-Object -Version | Select-Object -Last 1) }; $url = \\\"https://nwn.beamdog.net/downloads/nwnee-dedicated-$ReleaseVersion.zip\\\"; Invoke-WebRequest -Uri $url -OutFile 'nwnee.zip'; Expand-Archive -Path 'nwnee.zip' -DestinationPath '.' -Force; Remove-Item 'nwnee.zip'\"",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Demo Mod Download",
        "UpdateSourcePlatform": "Windows",
        "UpdateSource": "FetchURL",
        "UpdateSourceData": "https://raw.githubusercontent.com/urothis/nwserver/refs/heads/main/DockerDemo.mod",
        "UpdateSourceTarget": "{{$FullBaseDir}}user/modules",
        "UpdateSourceArgs": "Demo.mod",
        "OverwriteExistingFiles": true,
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Download Python",
        "UpdateSourcePlatform": "Windows",
        "UpdateSource": "FetchURL",
        "UpdateSourceData": "https://www.python.org/ftp/python/3.11.5/python3115-embed-amd64.zip",
        "UpdateSourceTarget": "{{$FullBaseDir}}",
        "UpdateSourceArgs": "python.zip",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Extract Python",
        "UpdateSourcePlatform": "Windows",
        "UpdateSource": "Executable",
        "UpdateSourceData": "powershell.exe",
        "UpdateSourceArgs": "-Command \"Expand-Archive -Path 'python.zip' -DestinationPath 'python' -Force\"",
        "SkipOnFailure": false
    },
    {
        "UpdateStageName": "Start Server",
        "UpdateSourcePlatform": "Windows",
        "UpdateSource": "StartApplication"
    },
    {
        "UpdateStageName": "Wait For Server Start",
        "UpdateSourcePlatform": "Windows",
        "UpdateSource": "WaitForStartupComplete"
    },
    {
        "UpdateStageName": "Stop Server",
        "UpdateSourcePlatform": "Windows",
        "UpdateSource": "ShutdownApplication"
    }
]